<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>공항철도 AREX 마스터 v2.4</title>
    <style>
        :root {
            --panel-bg: #2c3e50;
            --screen-bg: #0b131a;
            --accent-blue: #0097da;
            --led-green: #2ecc71;
            --led-red: #e74c3c;
            --warning-orange: #f39c12;
            --text-color: #ecf0f1;
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: #1a1a1a;
            font-family: 'Pretendard', sans-serif;
            color: var(--text-color);
            overflow: hidden;
            user-select: none;
        }

        .cab-container {
            display: grid;
            grid-template-rows: 60px 1fr 140px;
            height: 100vh;
            gap: 10px;
            padding: 10px;
            box-sizing: border-box;
        }

        /* 상단 네비게이션 */
        .top-bar {
            background: #333;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            border: 2px solid #555;
        }

        .station-display {
            background: #000;
            padding: 5px 20px;
            border: 1px solid var(--accent-blue);
            border-radius: 5px;
            color: var(--led-green);
            font-weight: bold;
            font-size: 1.1rem;
        }

        /* 메인 영역 레이아웃 */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            gap: 15px;
        }

        /* 제어 레버 영역 */
        .lever-area {
            background: var(--panel-bg);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            position: relative;
        }

        input[type=range].vertical-lever {
            appearance: none;
            width: 180px;
            height: 40px;
            background: #111;
            transform: rotate(-90deg);
            margin: 90px -70px;
            border-radius: 20px;
            border: 4px solid #555;
        }

        input[type=range].vertical-lever::-webkit-slider-thumb {
            appearance: none;
            width: 50px; height: 50px;
            background: #95a5a6;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 10px black;
        }

        .lever-val {
            margin-top: 130px;
            font-size: 1.4rem;
            font-weight: bold;
            padding: 5px 15px;
            background: #000;
            border-radius: 5px;
        }

        /* 중앙 계기판 섹션 */
        .center-display {
            display: grid;
            grid-template-rows: 1.2fr 0.8fr 1fr;
            gap: 10px;
        }

        .gauge-panel {
            background: #000;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 3px solid #333;
        }

        .speed-digit {
            font-size: 4.5rem;
            font-family: 'Courier New', monospace;
            color: var(--led-green);
            line-height: 1;
        }

        /* 객실 현황판 */
        .train-occupancy-board {
            background: #151e27;
            border-radius: 10px;
            border: 2px solid #444;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 5px;
        }

        .car-unit {
            flex: 1;
            margin: 0 3px;
            background: #2c3e50;
            border: 1px solid #555;
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 3px 0;
            position: relative;
        }

        .car-label { font-size: 0.65rem; color: #bdc3c7; margin-bottom: 3px; }
        
        .occupancy-bar-bg {
            width: 80%;
            height: 25px;
            background: #111;
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }

        .occupancy-fill {
            width: 100%;
            position: absolute;
            bottom: 0;
            transition: height 0.5s ease;
        }

        .car-door-indicator {
            width: 100%;
            height: 4px;
            margin-top: 4px;
            background: var(--led-green);
        }
        .car-door-indicator.open { background: var(--led-red); animation: blink 0.5s infinite; }

        /* TCMS 화면 */
        .tcms-panel {
            background: var(--screen-bg);
            border-radius: 10px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            border: 2px solid #444;
        }

        .tcms-screen {
            flex: 1;
            font-size: 0.8rem;
            color: #ecf0f1;
            padding: 5px;
        }

        .tcms-btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .tcms-btn {
            background: #34495e; color: white; border: none; padding: 8px; cursor: pointer; border-radius: 3px;
        }
        .tcms-btn.active { background: var(--accent-blue); }

        /* 공통 버튼 */
        .rect-btn { width: 100%; padding: 15px 0; border: none; border-radius: 5px; font-weight: bold; color: white; cursor: pointer; margin-bottom: 10px; transition: 0.3s; }
        .rect-btn:disabled { background: #1a1a1a !important; color: #444; cursor: not-allowed; opacity: 0.5; }

        @keyframes blink { 50% { opacity: 0; } }

        /* 하단 레이아웃 */
        .bottom-panel {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
        }

        .radio-box { background: #1e1e1e; border: 3px solid #444; border-radius: 10px; display: flex; align-items: center; padding: 10px; gap: 10px; }
        .ptt-btn { width: 50px; height: 70px; background: #c0392b; border-radius: 5px; cursor: pointer; }
        .ann-grid { background: #2c3e50; border-radius: 10px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
        .ann-btn { background: #34495e; color: white; border: 1px solid #555; border-radius: 5px; }
    </style>
</head>
<body>

<div class="cab-container">
    <header class="top-bar">
        <select id="routeSelect" onchange="initRoute()">
            <option value="toIncheon">인천공항2터미널 행</option>
            <option value="toSeoul">서울역 행</option>
        </select>
        <div class="station-display">
            NEXT: <span id="nextStation">서울역</span>
        </div>
        <div id="clock">00:00:00</div>
    </header>

    <main class="main-content">
        <!-- 1. 왼쪽: 주간제어기 (가속) -->
        <section class="lever-area">
            <div style="font-weight:bold; color:var(--led-green); font-size:0.9rem;">주간제어기(P)</div>
            <input type="range" id="pwrLev" class="vertical-lever" min="0" max="5" value="0">
            <div id="pwrVal" class="lever-val" style="color:var(--led-green)">P0</div>
            
            <div style="width:100%; margin-top:30px;">
                <button class="rect-btn" style="background:#f1c40f; color:black" onclick="handleDoor(true)">문 열림</button>
                <button class="rect-btn" style="background:#7f8c8d" onclick="handleDoor(false)">문 닫힘</button>
            </div>
        </section>

        <!-- 2. 중앙: 속도계 + 객실현황 + TCMS -->
        <section class="center-display">
            <div class="gauge-panel">
                <div style="color:#666; font-size:0.7rem">SPEEDOMETER</div>
                <div class="speed-digit" id="speedDisp">0</div>
                <div style="color:#666; font-size:0.8rem">km/h</div>
            </div>

            <div class="train-occupancy-board" id="occupancyBoard"></div>

            <div class="tcms-panel">
                <div class="tcms-screen" id="tcmsMonitor">
                    <div id="doorStatus" style="color:var(--led-red)">[출입문] 열림</div>
                    <div id="hvacStatus">[냉난방] 정지</div>
                    <div id="lightStatus">[객실조명] 소등</div>
                    <div id="arriveLockStatus" style="color:var(--warning-orange)">[정차상태] 출발대기</div>
                </div>
                <div class="tcms-btn-grid">
                    <button class="tcms-btn" id="btnHvac" onclick="toggleTcms('hvac')">냉난방</button>
                    <button class="tcms-btn" id="btnLight" onclick="toggleTcms('light')">객실조명</button>
                </div>
            </div>
        </section>

        <!-- 3. 오른쪽: 제동변환기 (감속) -->
        <section class="lever-area">
            <div style="font-weight:bold; color:var(--led-red); font-size:0.9rem;">제동변환기(B)</div>
            <input type="range" id="brkLev" class="vertical-lever" min="0" max="8" value="8">
            <div id="brkVal" class="lever-val" style="color:var(--led-red)">B8</div>

            <div style="width:100%; margin-top:30px;">
                <button class="rect-btn" style="background:#c0392b" id="btnArrive" onclick="pressArrive()">도착 정지</button>
                <button class="rect-btn" style="background:radial-gradient(#ff4d4d, #990000); height:80px;" onclick="emergencyBrake()">긴급 제동</button>
            </div>
        </section>
    </main>

    <footer class="bottom-panel">
        <div class="radio-box">
            <div class="ptt-btn" onmousedown="radioOn()" onmouseup="radioOff()"></div>
            <div style="font-size:0.75rem"><strong>TRS 무전기</strong><br><span id="radioStatus">대기...</span></div>
        </div>
        <div class="ann-grid">
            <button class="ann-btn" onclick="playAnn(1)">역 안내</button>
            <button class="ann-btn" onclick="playAnn(2)">발 빠짐</button>
            <button class="ann-btn" id="btnTerm" onclick="playAnn(3)" disabled>종점 방송</button>
        </div>
    </footer>
</div>

<script>
    const stations = ["서울역", "공덕", "홍대입구", "디지털미디어시티", "마곡나루", "김포공항", "계양", "검암", "청라국제도시", "영종", "운서", "공항화물청사", "인천공항1터미널", "인천공항2터미널"];
    let currentRoute = [];
    let sIdx = 0;
    let speed = 0;
    let isDoorOpen = true;
    let isEB = false;
    let hvac = false;
    let light = false;
    let hasArrivedAtCurrentStation = true; 
    let occupancyLevels = [20, 45, 80, 55, 30];

    function initRoute() {
        const dir = document.getElementById('routeSelect').value;
        currentRoute = dir === 'toIncheon' ? [...stations] : [...stations].reverse();
        sIdx = 0; speed = 0; isEB = false;
        hasArrivedAtCurrentStation = true; 
        createOccupancyBoard();
        updateUI();
    }

    function createOccupancyBoard() {
        const board = document.getElementById('occupancyBoard');
        board.innerHTML = '';
        for(let i=1; i<=5; i++) {
            const level = occupancyLevels[i-1];
            const color = level > 70 ? 'var(--led-red)' : (level > 40 ? 'var(--warning-orange)' : 'var(--led-green)');
            const car = document.createElement('div');
            car.className = 'car-unit';
            car.innerHTML = `<div class="car-label">${i}호차</div><div class="occupancy-bar-bg"><div class="occupancy-fill" style="height:${level}%; background:${color};"></div></div><div id="door-ind-${i}" class="car-door-indicator ${isDoorOpen ? 'open' : ''}"></div>`;
            board.appendChild(car);
        }
    }

    // 물리 엔진 및 자동 출발 로직
    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        const pwr = parseInt(document.getElementById('pwrLev').value);
        const brk = parseInt(document.getElementById('brkLev').value);
        
        document.getElementById('pwrVal').innerText = "P" + pwr;
        document.getElementById('brkVal').innerText = (brk === 0) ? "RUN" : "B" + brk;

        if (isEB) {
            speed -= 4.0;
        } else {
            // [자동 출발 로직] 가속 레버가 1 이상이고, 브레이크가 해제되었으며, 문이 닫혔을 때
            if (pwr > 0 && brk === 0 && !isDoorOpen) {
                speed += (pwr * 0.25);
                
                // 만약 현재 '도착 완료' 상태라면, 가속하는 순간 '주행 중'으로 상태 변경
                if (hasArrivedAtCurrentStation) {
                    hasArrivedAtCurrentStation = false;
                    isEB = false;
                    document.getElementById('arriveLockStatus').innerText = "[정차상태] 주행 중";
                    document.getElementById('arriveLockStatus').style.color = "white";
                    updateUI();
                }
            } 
            
            if (brk > 0) speed -= (brk * 0.4); 
            else speed -= 0.05;
        }

        if (speed < 0) speed = 0;
        if (speed > 110) speed = 110;

        const dispSpeed = Math.floor(speed);
        document.getElementById('speedDisp').innerText = dispSpeed;
        
        // 도착 정지 버튼 활성화 조건
        const btnArrive = document.getElementById('btnArrive');
        if (dispSpeed === 0 && !isEB && !hasArrivedAtCurrentStation) {
            btnArrive.disabled = false;
            btnArrive.style.boxShadow = "0 0 15px var(--led-red)";
        } else {
            btnArrive.disabled = true;
            btnArrive.style.boxShadow = "none";
        }
    }, 100);

    function handleDoor(open) {
        if (speed > 0) { speak("열차가 주행 중에는 문을 열 수 없습니다."); return; }
        isDoorOpen = open;
        document.getElementById('doorStatus').innerText = open ? "[출입문] 열림" : "[출입문] 닫힘";
        document.getElementById('doorStatus').style.color = open ? "var(--led-red)" : "var(--led-green)";
        for(let i=1; i<=5; i++) {
            const ind = document.getElementById(`door-ind-${i}`);
            if(open) ind.classList.add('open'); else ind.classList.remove('open');
        }
        speak(open ? "문이 열립니다." : "문이 닫힙니다.");
    }

    function pressArrive() {
        if (hasArrivedAtCurrentStation) return;
        if (sIdx < currentRoute.length - 2) {
            sIdx++;
            hasArrivedAtCurrentStation = true; 
            updateUI();
            occupancyLevels = occupancyLevels.map(l => Math.max(10, Math.min(95, l + (Math.random()*40 - 20))));
            createOccupancyBoard();
            document.getElementById('arriveLockStatus').innerText = "[정차상태] 도착 완료";
            document.getElementById('arriveLockStatus').style.color = "var(--led-green)";
            speak("잠시 후 도착합니다.");
        }
    }

    function emergencyBrake() {
        isEB = true;
        document.getElementById('brkLev').value = 8;
        document.getElementById('pwrLev').value = 0;
        speak("긴급 제동!");
    }

    function updateUI() {
        const next = currentRoute[sIdx + 1] || "종착역";
        document.getElementById('nextStation').innerText = next;
        document.getElementById('btnTerm').disabled = (sIdx + 1 !== currentRoute.length - 1);
    }

    function toggleTcms(type) {
        if(type === 'hvac') {
            hvac = !hvac;
            document.getElementById('hvacStatus').innerText = hvac ? "[냉난방] 가동 중" : "[냉난방] 정지";
            document.getElementById('btnHvac').classList.toggle('active');
        } else if(type === 'light') {
            light = !light;
            document.getElementById('lightStatus').innerText = light ? "[객실조명] 점등" : "[객실조명] 소등";
            document.getElementById('btnLight').classList.toggle('active');
        }
    }

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function makeStatic() {
        const node = audioCtx.createBufferSource();
        const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.3, audioCtx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
        node.buffer = buffer; node.connect(audioCtx.destination); node.start();
    }
    function radioOn() { makeStatic(); document.getElementById('radioStatus').innerText = "송신 중..."; }
    function radioOff() {
        document.getElementById('radioStatus').innerText = "수신 중...";
        setTimeout(() => { makeStatic(); speak("관제실입니다. 말씀하세요."); }, 500);
    }
    function speak(text) {
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'ko-KR';
        window.speechSynthesis.speak(msg);
    }
    function playAnn(type) {
        const next = currentRoute[sIdx + 1];
        if (type === 1) speak(`이번 역은 ${next}, ${next} 역입니다.`);
        if (type === 2) speak(`발 빠짐 주의.`);
        if (type === 3) speak(`우리 열차는 마지막 역인 ${next}역에 도착합니다.`);
    }

    window.onload = initRoute;
</script>
</body>
</html>
